id: 4ac6735f-a1ec-441a-8022-d502cf95c63a
# opnrvn-r-144
refId: aws-management-tools-cloudtrail-security-trail-enabled
type: asset
name: >
  Checks that there is at least one AWS CloudTrail trail defined with security best practices + 7 rule recommendations.
description: >
  This rule is COMPLIANT if there is at least one trail that meets all of the following:
  - Records global service events
  - Is a multi-region trail
  - Has Log file validation enabled
  - Encrypted with a KMS key
  - Records events for reads and writes
  - Records management events
  - Does not exclude any management events
  This rule is NON_COMPLIANT if no trails meet all of the criteria mentioned above.
severity: high
enabled: true
sql: >
    SELECT 'No correctly configured AWS CloudTrail trails' AS arn
    WHERE NOT EXISTS
    (SELECT *
    FROM ${magpie_schema}.awscloudtrailtrail
    WHERE EXISTS
    (SELECT *
    FROM jsonb_array_elements(supplementaryconfiguration->'eventSelectors'->'eventSelectors') eventSelector
    WHERE eventSelector->>'includeManagementEvents' = 'true'
    AND eventSelector->>'readWriteType' = 'All'
    AND eventSelector->>'excludeManagementEventSources' = '[]'
    AND supplementaryconfiguration->'trailDetails'->'trail'->'logFileValidationEnabled' = 'true'
    AND supplementaryconfiguration->'trailDetails'->'trail'->'isMultiRegionTrail' = 'true'
    AND supplementaryconfiguration->'trailDetails'->'trail'->'includeGlobalServiceEvents' = 'true'
    AND supplementaryconfiguration->'trailDetails'->'trail'->'kmsKeyId' != 'null'));
remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 1.0
